# linux常用命令的隐式能力



## 常见 Linux 命令的「固定思维」对应关系

- **zip / tar / 7z** → 压缩工具

- **find / locate** → 文件查找工具

- **awk / sed / grep** → 文本处理工具

- **cat / less / more** → 文件查看工具

- **cp / mv / rm** → 文件管理工具

- **git / svn** → 版本管理工具

- **curl / wget** → 下载工具

- **ssh / scp / rsync** → 远程连接 / 传输工具

- **make / gcc / g++** → 构建 / 编译工具

- **crontab** → 定时任务工具

    

##  Linux 常用命令的「隐式能力」表

| 命令        | 隐式能力 | 典型危险参数 / 特性         | 示例（说明隐式能力）                                         | 审计关注点         |                         |
| ----------- | -------- | --------------------------- | ------------------------------------------------------------ | ------------------ | ----------------------- |
| **zip**     | 执行命令 | `-T -TT`                    | `zip a.zip aa -T -TT 'touch b'`                              | 参数是否可控       | 压缩工具 ≠ 只能压缩     |
| **tar**     | 执行命令 | `--checkpoint-action=exec=` | `tar cf a.tar aa --checkpoint=1 --checkpoint-action=exec='touch bb'` | 是否允许高级参数   |                         |
| **find**    | 执行命令 | `-exec`                     | `find . -name aa -exec touch bb \;`                          | 是否拼接 find 参数 | 查文件 ≠ 不执行命令     |
| **awk**     | 执行命令 | `system()`                  | `awk 'BEGIN { system("touch bb") }'`                         | 是否允许表达式     | 文本处理器自带 system() |
| **sed**     | 执行命令 | `e` 指令                    | `echo test | sed '1e touch bb'`                              | 是否允许脚本       | 替换文本时执行命令      |
| **xargs**   | 执行命令 | 默认执行                    | `echo bb| xargs touch`                                       | 参数是否过滤       | 参数直接变成命令        |
| **env**     | 执行命令 | `env cmd`                   | `env touch bb`                                               | 常被忽略           | 设置环境 + 执行命令     |
| **nohup**   | 执行命令 | 任意命令                    | `nohup touch bb &`                                           | 后台绕过           | 后台执行 ≠ 安全         |
| **timeout** | 执行命令 | 后接命令                    | `timeout 10 touch bb`                                        |                    | 看似安全                |
| **watch**   | 执行命令 | 参数即命令                  | `watch touch bb`                                             |                    | UI 工具≠安全            |

---

##  文件读取 / 写入（间接命令注入链）

| 命令        | 隐式能力   | 危险参数 | 示例                                                         | 风险说明 |                                      |
| ----------- | ---------- | -------- | ------------------------------------------------------------ | -------- | ------------------------------------ |
| **cat**     | 任意文件读 | 文件路径 | `cat /etc/shadow`                                            | 配合回显 |                                      |
| **cp**      | 任意文件写 | 目标路径 | `cp /bin/sh /tmp/x`                                          | 覆盖文件 |                                      |
| **tee**     | 任意文件写 | 重定向   | `echo 'touch bb' | tee run.sh`                               | 常被忽略 |                                      |
| **dd**      | 原始写     | `of=`    | `dd if=/bin/sh of=/tmp/x`                                    | 高危     | if=任意文件读取<br />of=任意文件写入 |
| **install** | 写+权限    | `-m`     | echo 'int main(){}' > aa.c<br/>gcc aa.c -o aa<br/>install -m 4755 aa bb | SUID 链  | `bb` 变成 SUID 程序                  |
| **ln**      | 覆盖链接   | 目标路径 | `ln -sf /etc/passwd x`                                       | 配合写   |                                      |

---

##  编辑器 / Pager

| 命令       | 隐式能力 | 逃逸方式 | 示例                                      | 说明 |
| ---------- | -------- | -------- | ----------------------------------------- | ---- |
| **vi/vim** | Shell    | `:!cmd`  | vim aa<br/># 在 vim 内输入<br/>:!touch bb |      |
| **less**   | Shell    | `!cmd`   | `!touch bb`                               |      |
| **more**   | Shell    | `!cmd`   | `!touch bb`                               |      |
| **man**    | Shell    | pager    | man ls<br/># 进入 man 后<br/>!touch bb    |      |

---

##  网络 / 版本管理

| 命令         | 隐式能力       | 危险点                 | 示例                                         | 审计提示    |
| ------------ | -------------- | ---------------------- | -------------------------------------------- | ----------- |
| **git**      | Shell / 读文件 | `PAGER`(分页器)        | `PAGER='touch bb' git diff`                  | env 注入    |
| **ssh**      | 执行命令       | `ProxyCommand`（跳转） | `ssh -o ProxyCommand='touch bb' example.com` | config 注入 |
| **scp**      | 执行命令       | 远端路径               | `scp '$(touch bb)' user@host:/tmp/`          | shell 解析  |
| **ftp/sftp** | Shell          | `!cmd`                 | ftp localhost<br/>ftp> !touch bb             | 交互逃逸    |



## 白名单 + 格式化字符校验无法拦截的场景

当前的防护模型：

```
外部输入
  ↓
字符转义 / replace
  ↓
白名单校验（字符）
  ↓
拼成命令字符串
  ↓
system / popen / sh -c
```

**这个模型隐含了一个前提假设：**

> “危险一定来自特殊字符（`; | && $ ()`）”



### 参数合法

举例：文本处理工具awk ，sed

```bash
awk 'BEGIN {system("touch bb")}'
sed '1e touch bb'
```



### 白名单+转义字符未校验 空格 首字符-开头

```bash
system("tar cf a.tar " + file1 + " " + file2);
file2 ： aa --checkpoint-action=exec=touchbb
```



### 通配符展开 + 文件名被当成参数 的命令注入

工程代码（或脚本）：

```bash
zip a.zip *
```

目录中存在恶意文件：

```bash
-T
-TT
touch b
```

Shell 实际执行等价于：

```bash
zip a.zip -T -TT 'touch b'
```



修改方法1：

```bash
zip a.zip -- *
```

含义：

> -- 之后的内容，全部当作“非选项参数（文件名）”





## 安全审计时的关键判断逻辑

1. 这条命令是否接受外部输入？
2. 外部输入是否进入命令参数？
3. 是否存在 shell 解析（system/popen/sh -c）？
4. 是否允许可变参数或可控的“选项参数”？
5. 是否能通过 `--` 终止选项解析？
6. 是否存在文件名通配符/空格/换行/特殊字符绕过？
7. 是否可被环境变量污染（PAGER/LD_PRELOAD 等）？

